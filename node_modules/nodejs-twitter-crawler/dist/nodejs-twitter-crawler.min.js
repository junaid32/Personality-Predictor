var CRITICAL_ERRORS,INVALID_OR_EXPIRED_TOKEN,MAX_COUNT,Promise,RATE_LIMIT_EXCEEDED,TwitterClient,TwitterCrawler,_,enabled,errorCode,extend,getLogger,isArray,isInt,isNaN,isNumericId,isString,winston,slice=[].slice,indexOf=[].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1};TwitterClient=require("twitter"),Promise=require("bluebird"),_=require("underscore"),isNaN=_.isNaN,isString=_.isString,isArray=_.isArray,extend=_.extendOwn,winston=require("winston"),MAX_COUNT=200,RATE_LIMIT_EXCEEDED=88,INVALID_OR_EXPIRED_TOKEN=89,CRITICAL_ERRORS=[RATE_LIMIT_EXCEEDED,INVALID_OR_EXPIRED_TOKEN],isNumericId=function(e){return!isNaN(parseInt(e))},getLogger=function(e){return null==e&&(e={}),new winston.Logger({transports:[new winston.transports.Console({level:e.debug?"debug":"info",label:"twitter-crawler"})]})},isInt=function(e){return!isNaN(e)&&parseInt(Number(e))===e&&!isNaN(parseInt(e,10))},errorCode=function(e){return e.code||(e[0]?e[0].code:0)},enabled=function(e){return e.filter(function(e){return function(e){return null==e.enabled||e.enabled}}(this))},TwitterCrawler=function(){function e(e,t){null==t&&(t={}),this.logger=getLogger(t),this.setOptions(t),this.count=0,this.createClients(e)}return e.prototype.validateCredentials=function(e){if(!e||isArray(e)&&0===enabled(e).length)throw new Error("You must provide valid credentials")},e.prototype.createClients=function(e){return this.clients=[],this.validateCredentials(e),enabled(e).forEach(function(e){return function(t){var r;return r=new TwitterClient(t),r._instance_id=e.clients.length,r._valid=!0,e.clients.push(r)}}(this))},e.prototype.setOptions=function(e){return this.options=extend({debug:!1},e)},e.prototype.getInstance=function(){var e,t;for(t=this.count%this.clients.length,e=1,this.count++;!this.clients[t]._valid&&e<=this.clients.length;)e+=1,this.count++,t=this.count%this.clients.length;return e>this.clients.length?null:(this.logger.debug("Using twitter credentials nÂº"+t),this.clients[t])},e.prototype.callApi=function(){var e,t;if(t=arguments[0],e=2<=arguments.length?slice.call(arguments,1):[],"get"!==t&&"post"!==t)throw new Error("Method '"+t+"' not implemented.");return new Promise(function(r){return function(n,i){var s,o,l;return o=r.getInstance(),null!=o?(s=function(s,l){var c,a;return s?(c="Error calling '"+e[0]+"' api ["+t.toUpperCase()+"] on instance "+o._instance_id+".",32===errorCode(s)&&(c+=" Error code: "+errorCode(s)+".",r.logger.error(c,"Using another instance.",s),r.callApi.apply(r,[t].concat(slice.call(e))).then(n)["catch"](i)),a=errorCode(s),indexOf.call(CRITICAL_ERRORS,a)>=0?(c+=" Error code: "+errorCode(s)+".",o._valid=!1,o._error=s,r.logger.error(c,"Using another instance.",s),r.callApi.apply(r,[t].concat(slice.call(e))).then(n)["catch"](i)):(r.logger.error(c),r.logger.error(s),i(s))):n(l)},o[t].apply(o,e.concat([s]))):(l="All instances are invalid! Review your credentials",r.logger.debug(l),i(new Error(l)))}}(this))},e.prototype.get=function(){var e;return e=1<=arguments.length?slice.call(arguments,0):[],this.callApi.apply(this,["get"].concat(slice.call(e)))},e.prototype.post=function(){var e;return e=1<=arguments.length?slice.call(arguments,0):[],this.callApi.apply(this,["post"].concat(slice.call(e)))},e.prototype._getTweets=function(e,t,r){return null==r&&(r=[]),new Promise(function(n){return function(i,s){var o;return o=function(o){var l,c,a,u;return u=o[0].user,t.limit&&u.statuses_count<t.limit&&(t.limit=u.statuses_count),t.min_tweets&&u.statuses_count<t.min_tweets?(c=["Not enough tweets for user @",u.screen_name,":","expected at least",t.min_tweets,"but user has",u.statuses_count,"tweets"].join(" "),n.logger.error(c),s(new Error(c))):(n.logger.debug("Obtained",o.length,"tweets for user","@"+u.screen_name+".","Total collected tweets for @"+u.screen_name+":",o.length+r.length),l=t.limit&&r.length+o.length>t.limit,o.length>1&&!l?n._getTweets(extend(e,{maxId:o[o.length-1].id-1}),t,r.concat(o)).done(i,s):(a=r.concat(o),t.limit&&(a=a.slice(0,+t.limit+1||9e9)),i(a)))},n.get("statuses/user_timeline",e).done(o,s)}}(this))},e.prototype.getTweets=function(e,t){var r;return null==t&&(t={}),(isString(e)||isNumericId(e))&&(r=e,e={user_id:isNumericId(r)?r:void 0,screen_name:isNumericId(r)?void 0:r.replace("@",""),count:MAX_COUNT,exclude_replies:!0,maxId:void 0,include_rts:!1}),this._getTweets(e,t)},e.prototype.getUser=function(e){var t;return(isString(e)||isNumericId(e))&&(t=e,e={user_id:isNumericId(t)?t:void 0,screen_name:isNumericId(t)?void 0:t.replace("@","")}),this.get("users/show",e)},e}(),module.exports=TwitterCrawler;